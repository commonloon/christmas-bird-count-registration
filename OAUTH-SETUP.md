# OAuth Setup Guide for Christmas Bird Count Registration

*NOTE* This file was auto-generated by Claude.  It may not perfectly reflect the oauth setup process, but it should be close.

This guide provides complete instructions for setting up Google OAuth authentication for the CBC Registration Flask application deployed on Google Cloud Run. These instructions are based on successful deployment and testing.

## Prerequisites

- Google Cloud project created (replace `vancouver-cbc-registration` with your project ID)
- Two Cloud Run services planned: `cbc-test` and `cbc-registration` (or your preferred names)
- Custom domains configured (optional but recommended)
- gcloud CLI installed and authenticated
- Git Bash (for Windows) or similar terminal with Python available

## Step 1: Create OAuth Client Credentials

### 1.1 Configure OAuth Consent Screen

1. Go to [Google Cloud Console - OAuth Consent Screen](https://console.cloud.google.com/apis/credentials/consent)
2. Select your project: `vancouver-cbc-registration`
3. Choose **"External"** user type (unless you have Google Workspace)
4. Fill in required fields:
   - **App name**: "Christmas Bird Count Registration"
   - **User support email**: `birdcount@naturevancouver.ca`
   - **Developer contact email**: `birdcount@naturevancouver.ca`
5. Add scopes:
   - `../auth/userinfo.email`
   - `../auth/userinfo.profile`
   - `openid`
6. Save and continue

### 1.2 Create OAuth Client ID

1. Go to [Google Cloud Console - Credentials](https://console.cloud.google.com/apis/credentials)
2. Click **"+ CREATE CREDENTIALS"** → **"OAuth client ID"**
3. Configure the client:
   - **Application type**: "Web application"
   - **Name**: "CBC Registration Web Client"
   - **Authorized JavaScript origins**:
     ```
     https://cbc-test.naturevancouver.ca
     https://cbc-registration.naturevancouver.ca
     ```
   - **Authorized redirect URIs**: **LEAVE EMPTY** (Google Identity Services doesn't use redirect URIs)
4. Click **"Create"**
5. **Download the JSON file** and save as `client_secret.json` in your project root
6. **Important**: Add `client_secret.json` to your `.gitignore` file

## Step 2: Store Credentials in Google Secret Manager

### 2.1 Enable Secret Manager API

```bash
gcloud services enable secretmanager.googleapis.com
```

### 2.2 Create Secrets from OAuth Credentials

**IMPORTANT:** The project includes a script that handles this automatically and works with Git Bash on Windows.

1. Place your downloaded `client_secret.json` file in the project root directory
2. Run the setup script:
   ```bash
   ./utils/setup_oauth_secrets.sh
   ```
3. The script will:
   - Extract client ID and secret from the JSON file
   - Generate a secure Flask secret key
   - Create secrets in Google Secret Manager
   - Grant proper IAM permissions to Cloud Run
   - Display verification info
4. **Delete the `client_secret.json` file** after running the script for security

## Step 3: Deploy Services with OAuth Configuration

**IMPORTANT:** The project includes deployment scripts that handle this automatically.

### 3.1 Deploy Test Instance

```bash
./deploy.sh test
```

### 3.2 Deploy Production Instance

```bash
./deploy.sh production
```

### 3.3 Deploy Both Instances

```bash
./deploy.sh both
```

The deployment script automatically includes all required environment variables and secrets.

## Step 4: Configure Custom Domains (if not already done)

### 4.1 Map Domains to Services

```bash
gcloud run domain-mappings create \
    --service cbc-test \
    --domain cbc-test.naturevancouver.ca \
    --region us-central1

gcloud run domain-mappings create \
    --service cbc-registration \
    --domain cbc-registration.naturevancouver.ca \
    --region us-central1
```

### 4.2 Update DNS Records

Add these CNAME records to your `naturevancouver.ca` domain:
```
CNAME cbc-test.naturevancouver.ca → ghs.googlehosted.com
CNAME cbc-registration.naturevancouver.ca → ghs.googlehosted.com
```

## Step 5: Publish OAuth Consent Screen

**CRITICAL:** The OAuth consent screen must be published for authentication to work properly.

1. Go to [OAuth Consent Screen](https://console.cloud.google.com/apis/credentials/consent)
2. Click **"PUBLISH APP"** 
3. Change status from "Testing" to "In production"
4. Confirm publishing

**Note:** If you leave it in "Testing" mode, only test users can authenticate, and you'll get "OAuth client not found" errors.

## Step 6: Test OAuth Flow

### 6.1 Test the Login Flow

**Test instance:**
```
https://cbc-test.naturevancouver.ca/auth/login
```

**Production instance:**
```
https://cbc-registration.naturevancouver.ca/auth/login
```

### 6.2 Verify Configuration

Check that secrets are properly mounted:
```bash
gcloud run services describe cbc-test --region us-central1 --format="export" | grep -A 10 "env:"
```

Check application logs for errors:
```bash
gcloud logs read --service cbc-test --region us-central1 --limit 20
```

## Step 7: Flask Application Requirements

Ensure your `app.py` includes the OAuth configuration:

```python
import os
from authlib.integrations.flask_client import OAuth

# OAuth configuration
app.config['GOOGLE_CLIENT_ID'] = os.environ.get('GOOGLE_CLIENT_ID')
app.config['GOOGLE_CLIENT_SECRET'] = os.environ.get('GOOGLE_CLIENT_SECRET')

# Initialize OAuth
oauth = OAuth(app)
google = oauth.register(
    name='google',
    client_id=app.config['GOOGLE_CLIENT_ID'],
    client_secret=app.config['GOOGLE_CLIENT_SECRET'],
    server_metadata_url='https://accounts.google.com/.well-known/openid_configuration',
    client_kwargs={'scope': 'openid email profile'}
)

# Make OAuth available to routes
app.oauth = oauth
app.google = google
```

## Troubleshooting

### Common Issues and Solutions

1. **"Google OAuth not configured" error**
   - Check that secrets are properly mounted: `gcloud run services describe SERVICE --region=REGION`
   - Verify the `init_auth(app)` function is called in `app.py`
   - Check application logs for import errors
   - Ensure Secret Manager API is enabled

2. **"OAuth client was not found" / "invalid_client" error**
   - Verify client ID matches exactly between Secret Manager and Google Console
   - **Check for trailing newlines** in the client ID secret (common issue!)
   - Ensure OAuth consent screen is **published** (not in testing mode)
   - Verify JavaScript origins are configured correctly (no redirect URIs needed)

3. **"Unsecured login_uri provided" error**
   - Ensure all URLs use HTTPS
   - Check that `_scheme='https'` is used in Flask `url_for()` calls
   - Verify custom domains have SSL certificates

4. **Database connection errors in OAuth callback**
   - Ensure Firestore is properly initialized in the auth route
   - Check that `GOOGLE_CLOUD_PROJECT` environment variable is set
   - Verify service account has Firestore access permissions

5. **Missing Firestore indexes**
   - Click the index creation URL provided in error logs
   - Wait for indexes to build (1-2 minutes) before retesting

### Verification Commands

```bash
# Check service configuration
gcloud run services describe cbc-test --region us-central1

# Check domain mappings
gcloud run domain-mappings list --region us-central1

# View application logs
gcloud logs read --service cbc-test --region us-central1 --limit 50

# Test domain accessibility
curl -I https://cbc-test.naturevancouver.ca
```

## Security Notes

- Keep `client_secret.json` out of version control
- Use Google Secret Manager for production credentials
- Configure proper redirect URIs for each environment
- Regularly review and update test user access
- Consider domain verification for production deployments

## Next Steps

After OAuth is working:
1. Test user registration and login flows
2. Verify admin and area leader role assignments
3. Test email notifications
4. Configure production monitoring and logging