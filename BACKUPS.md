# Firestore Backup System Setup
{# Updated by Claude AI on 2025-09-27 #}

This guide explains how to set up automated Firestore backups for the Christmas Bird Count registration system. The backup system creates hourly backups when data changes and automatically manages retention (60 days, always preserving the most recent backup).

## NOTE: these instructions were generated by AI and have not been tested.  They should work, but may need some modification.
You can ask an AI to help with that.

## Overview

The backup system consists of:
- **Cloud Function**: Checks for database changes and creates backups when needed
- **Cloud Scheduler**: Triggers the backup function every hour
- **Cloud Storage**: Stores backup files with automatic cleanup
- **Smart Retention**: Keeps backups for 60 days, but always preserves the most recent backup (important for seasonal usage)

## Prerequisites

Before setting up backups, ensure you have:

1. **Google Cloud Project** with the Christmas Bird Count application deployed
2. **gcloud CLI** installed and authenticated
3. **Project permissions** - You must be an owner or have sufficient IAM permissions

## Setup Instructions

### Step 1: Verify Prerequisites

```bash
# Check that gcloud is authenticated and pointing to correct project
gcloud config get-value project

# Verify this shows your project ID (e.g., "your-club-cbc-registration")
# If not, set the correct project:
# gcloud config set project YOUR_PROJECT_ID

# Check authentication
gcloud auth list
# You should see your account marked as ACTIVE
```

### Step 2: Configure IAM Permissions (Automated)

Use the provided script to automatically set up all required permissions:

```bash
# Run the automated permission setup script
python utils/setup_backup_permissions.py
```

This script will:
- ✅ Enable required Google Cloud APIs (Cloud Functions, Cloud Scheduler, Cloud Storage)
- ✅ Grant Firestore export permissions to the service account
- ✅ Grant Cloud Storage permissions to the service account
- ✅ Verify that all permissions were applied correctly

**If the script fails**, see the Manual IAM Setup section below.

### Step 3: Install Backup Dependencies

```bash
# Install additional Python dependencies for the backup utility
pip install -r utils/requirements.txt
```

### Step 4: Create Backup Storage Bucket

Choose a globally unique bucket name and create the storage bucket:

```bash
# Choose a unique bucket name (recommended format: CLUBNAME-cbc-backups)
BUCKET_NAME="yourclub-cbc-backups"

# Create the backup storage bucket
gsutil mb gs://$BUCKET_NAME

# Verify bucket was created
gsutil ls gs://$BUCKET_NAME
```

**Bucket naming guidelines**:
- Must be globally unique across all Google Cloud
- Use lowercase letters, numbers, hyphens only
- Recommended format: `yourclub-cbc-backups`
- Examples: `vancouver-cbc-backups`, `portland-cbc-backups`, `chicago-cbc-backups`

### Step 5: Deploy the Backup System

```bash
# Deploy the backup function and scheduler
python utils/deploy_backup_function.py YOUR_BUCKET_NAME

# Example:
python utils/deploy_backup_function.py yourclub-cbc-backups
```

The deployment script will:
- ✅ Read your database configuration automatically
- ✅ Create a Cloud Function that runs hourly backup checks
- ✅ Set up Cloud Scheduler to trigger the function every hour
- ✅ Configure the function with your project settings

### Step 6: Test the Backup System

```bash
# Test the backup function manually
gcloud functions call backup-firestore-hourly --region=us-west1

# Or test via HTTP (if you have curl):
curl -X GET "https://us-west1-YOUR_PROJECT_ID.cloudfunctions.net/backup-firestore-hourly"
```

**Expected response**: JSON with `"status": "success"` and a backup name, or `"status": "success"` with `"message": "No changes detected"` if no data has changed.

### Step 7: Verify Scheduled Backups

```bash
# Check that the scheduler job was created
gcloud scheduler jobs list --location=us-west1

# You should see: backup-firestore-hourly with schedule "0 * * * *" (every hour)
```

## Manual IAM Setup (If Script Fails)

If the automated permission setup script fails, you can configure permissions manually:

```bash
# Get your project number
PROJECT_NUMBER=$(gcloud projects describe $(gcloud config get-value project) --format="value(projectNumber)")

# Enable required APIs
gcloud services enable cloudfunctions.googleapis.com
gcloud services enable cloudscheduler.googleapis.com
gcloud services enable storage.googleapis.com

# Grant Firestore export permissions
gcloud projects add-iam-policy-binding $(gcloud config get-value project) \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/datastore.importExportAdmin"

# Grant Cloud Storage permissions
gcloud projects add-iam-policy-binding $(gcloud config get-value project) \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/storage.admin"
```

## Backup Behavior

### When Backups Are Created

- **Hourly checks**: Every hour on the hour (12:00, 1:00, 2:00, etc.)
- **Change detection**: Backups only created when participant, leader, or removal data has changed
- **No unnecessary backups**: If no changes detected, no backup is created (saves storage costs)

### Seasonal Usage Pattern

The system is designed for seasonal use (September-December active, January-August dormant):

- **Active season**: Regular backups as data changes
- **Dormant season**: No new backups (no data changes)
- **Most recent protection**: The last backup from December is preserved until the next season starts

### Retention Policy

- **Standard retention**: 60 days for regular backups
- **Most recent protection**: The newest backup is NEVER deleted, even if older than 60 days
- **Automatic cleanup**: Old backups are deleted automatically when new backups are created

## Monitoring and Management

### Check Backup Status

```bash
# View recent backup function logs
gcloud functions logs read backup-firestore-hourly --region=us-west1 --limit=10

# List current backups
gsutil ls gs://YOUR_BACKUP_BUCKET_NAME/

# Check scheduler job status
gcloud scheduler jobs describe backup-firestore-hourly --location=us-west1
```

### Manual Backup

If you need to create a backup manually (e.g., before major changes):

```bash
# Trigger backup manually
gcloud functions call backup-firestore-hourly --region=us-west1
```

### Backup Restoration

To restore from a backup:

```bash
# List available backups
gsutil ls gs://YOUR_BACKUP_BUCKET_NAME/

# Restore a specific backup (CAUTION: This overwrites current data)
gcloud firestore import gs://YOUR_BACKUP_BUCKET_NAME/cbc_backup_YYYYMMDD_HHMMSS/ \
  --database=YOUR_DATABASE_ID
```

**⚠️ Warning**: Restoration overwrites current data. Only restore when necessary and ensure you understand the implications.

## Troubleshooting

### Common Issues

**"403 Permission denied" errors**:
- Re-run the permission setup script: `python utils/setup_backup_permissions.py`
- Wait a few minutes for permission changes to propagate
- Check that you have sufficient permissions in the Google Cloud project

**"Function not found" errors**:
- Verify the function deployed successfully
- Check the region (should be us-west1)
- Ensure your gcloud CLI is pointing to the correct project

**"Bucket not found" errors**:
- Create the bucket manually: `gsutil mb gs://YOUR_BACKUP_BUCKET_NAME`
- Verify bucket name is globally unique

**Bucket name conflicts**:
- Try a different bucket name (must be globally unique)
- Use your organization name in the bucket name for uniqueness

**Backups not running**:
- Check scheduler job: `gcloud scheduler jobs list --location=us-west1`
- Review function logs for errors
- Re-run permission setup script

### Getting Help

**View detailed logs**:
```bash
# Function execution logs
gcloud functions logs read backup-firestore-hourly --region=us-west1 --limit=20

# Scheduler job logs
gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=backup-firestore-hourly" --limit=10
```

**Check system status**:
```bash
# Verify all components
gcloud functions describe backup-firestore-hourly --region=us-west1
gcloud scheduler jobs describe backup-firestore-hourly --location=us-west1
gsutil ls gs://YOUR_BACKUP_BUCKET_NAME/
```

**Re-run permission setup**:
```bash
# If you suspect permission issues, re-run the setup script
python utils/setup_backup_permissions.py
```

## Security Considerations

- **Bucket access**: Backup buckets use default project permissions
- **Service account**: Uses the default Compute Engine service account
- **Network**: Function uses Google Cloud's internal network for Firestore access
- **Retention**: Old backups are automatically deleted after 60 days (except most recent)

## Cost Estimation

**Monthly costs** (approximate):
- **Cloud Function**: ~$0.01/month (minimal usage, runs only when needed)
- **Cloud Scheduler**: Free tier (1 job)
- **Cloud Storage**: ~$0.02/GB/month for backup storage
- **Firestore Export**: ~$0.13 per export operation

**Total estimated cost**: $2-10/month depending on data size and change frequency.

## Advanced Configuration

### Changing Backup Frequency

To modify the backup schedule, update the Cloud Scheduler job:

```bash
# Change to every 6 hours instead of every hour
gcloud scheduler jobs update http backup-firestore-hourly \
  --location=us-west1 \
  --schedule="0 */6 * * *"
```

### Changing Retention Period

To modify the 60-day retention period, you would need to:
1. Update the backup function code in `utils/deploy_backup_function.py`
2. Change the `60` in the cleanup logic to your desired number of days
3. Redeploy: `python utils/deploy_backup_function.py YOUR_BUCKET_NAME`

### Cross-Region Backup

For additional protection, consider setting up cross-region replication:

```bash
# Enable cross-region replication on your backup bucket
gsutil versioning set on gs://YOUR_BACKUP_BUCKET_NAME
gsutil rewrite -s COLDLINE gs://YOUR_BACKUP_BUCKET_NAME/**
```

---

## Quick Setup Summary

For experienced administrators, here's the condensed setup procedure:

```bash
# 1. Set correct project
gcloud config set project YOUR_PROJECT_ID

# 2. Run automated permission setup
python utils/setup_backup_permissions.py

# 3. Install dependencies
pip install -r utils/requirements.txt

# 4. Create storage bucket
gsutil mb gs://YOUR_BUCKET_NAME

# 5. Deploy backup system
python utils/deploy_backup_function.py YOUR_BUCKET_NAME

# 6. Test
gcloud functions call backup-firestore-hourly --region=us-west1
```

## Summary

After completing this setup:

✅ **Automated hourly backup checks**
✅ **Smart change detection** (no unnecessary backups)
✅ **60-day retention with seasonal protection**
✅ **Automatic cleanup** of old backups
✅ **Cost-effective storage** (only pays for actual backups)
✅ **Monitoring and logging** for troubleshooting

Your Christmas Bird Count data is now automatically protected with a backup system designed for seasonal usage patterns.