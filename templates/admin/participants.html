{# Updated by Claude AI on 2025-09-23 #}
{% extends "base.html" %}

{% block title %}All Participants - Vancouver Christmas Bird Count{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>All Participants</h1>
    <div>
        <span class="badge bg-info">{{ selected_year }}</span>
        {% if current_user.email %}
        <span class="text-muted">{{ current_user.email }}</span>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary ms-2">Logout</a>
        {% endif %}
    </div>
</div>

<!-- Navigation breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard', year=selected_year) }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">All Participants</li>
    </ol>
</nav>

<!-- Year selector -->
{% if available_years and available_years|length > 1 %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Year Selection</h5>
        <form method="GET" class="d-inline-block">
            <select name="year" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('admin.unassigned', year=selected_year) }}" class="btn btn-warning me-2">Manage Unassigned</a>
                <a href="{{ url_for('admin.leaders', year=selected_year) }}" class="btn btn-info me-2">Manage Leaders</a>
                <a href="{{ url_for('admin.export_csv', year=selected_year) }}" class="btn btn-success">Export CSV</a>
            </div>
        </div>
    </div>
</div>

<!-- Area Navigation -->
{% set areas_with_participants = participants | groupby('preferred_area') | list %}
{% if areas_with_participants %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Jump to Area</h5>
        <div class="d-flex flex-wrap gap-2">
            {% for area_code, area_participants in areas_with_participants %}
            {% set area_label = 'UNASSIGNED' if area_code == 'UNASSIGNED' else 'Area ' + area_code %}
            <a href="#area-{{ area_code }}" class="btn btn-outline-primary btn-sm">{{ area_label }} ({{ area_participants|list|length }})</a>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Participants by Area -->
{% if participants %}
    {# Group participants by area and sort areas alphabetically #}
    {% for area_code in participants | map(attribute='preferred_area') | list | unique | sort %}
    {% set area_participants = participants | selectattr('preferred_area', 'equalto', area_code) | list %}
    {% if area_participants %}
    <div id="area-{{ area_code }}" class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                {% if area_code == 'UNASSIGNED' %}
                    UNASSIGNED ({{ area_participants|length }})
                {% else %}
                    Area {{ area_code }} ({{ area_participants|length }})
                    {% if area_leaders.get(area_code) %}
                        {% for leader in area_leaders[area_code] %}
                            <br><small class="text-muted">
                                â€¢ Leader: {{ leader.first_name|e }} {{ leader.last_name|e }}
                                <i class="bi bi-envelope-fill"></i> <a href="mailto:{{ leader.email|e }}">{{ leader.email|e }}</a>
                                <i class="bi bi-telephone-fill"></i> {{ leader.phone|e }}
                            </small>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Cell Phone</th>
                            <th>Skill Level</th>
                            <th>Experience</th>
                            <th>Equipment</th>
                            <th>Notes</th>
                            <th>Leader</th>
                            <th>Scribe</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Sort participants: regular first, then FEEDER, both by first name #}
                        {% set regular_participants = area_participants | selectattr('participation_type', 'ne', 'FEEDER') | sort(attribute='first_name') | list %}
                        {% set feeder_participants = area_participants | selectattr('participation_type', 'equalto', 'FEEDER') | sort(attribute='first_name') | list %}
                        {% set sorted_participants = regular_participants + feeder_participants %}
                        {% for participant in sorted_participants %}
                        <tr{% if participant.get('participation_type') == 'FEEDER' %} class="table-info"{% endif %} data-participant-id="{{ participant.id }}">
                            <td>
                                <div class="name-display">
                                    <strong class="participant-name">{{ participant.first_name|e }} {{ participant.last_name|e }}</strong>
                                    {% if participant.is_leader %}
                                        <span class="badge bg-success ms-1">Leader</span>
                                    {% endif %}
                                    {% if participant.get('participation_type') == 'FEEDER' %}
                                        <div class="small text-muted">FEEDER</div>
                                    {% endif %}
                                </div>
                                <div class="name-edit" style="display: none;">
                                    <div class="d-flex gap-1">
                                        <input type="text" class="form-control form-control-sm first-name-input" value="{{ participant.first_name|e }}" placeholder="First name">
                                        <input type="text" class="form-control form-control-sm last-name-input" value="{{ participant.last_name|e }}" placeholder="Last name">
                                    </div>
                                    {% if participant.is_leader %}
                                        <span class="badge bg-success ms-1">Leader</span>
                                    {% endif %}
                                    {% if participant.get('participation_type') == 'FEEDER' %}
                                        <div class="small text-muted">FEEDER</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="email-display">
                                    <a href="mailto:{{ participant.email|e }}">{{ participant.email|e }}</a>
                                </div>
                                <div class="email-edit" style="display: none;">
                                    <input type="email" class="form-control form-control-sm email-input" value="{{ participant.email|e }}">
                                </div>
                            </td>
                            <td>
                                <div class="phone-display">
                                    {{ participant.phone|e or 'N/A' }}
                                    {% if participant.get('phone2') %}
                                        <div class="small text-muted">{{ participant.phone2|e }}</div>
                                    {% endif %}
                                </div>
                                <div class="phone-edit" style="display: none;">
                                    <input type="tel" class="form-control form-control-sm phone-input mb-1" style="min-width: 140px;" value="{{ participant.phone or '' }}" placeholder="Cell phone">
                                    <input type="tel" class="form-control form-control-sm phone2-input" style="min-width: 140px;" value="{{ participant.phone2 or '' }}" placeholder="Secondary phone">
                                </div>
                            </td>
                            <td>
                                <div class="skill-display">
                                    <span class="badge bg-{% if participant.skill_level == 'Expert' %}success{% elif participant.skill_level == 'Intermediate' %}primary{% elif participant.skill_level == 'Beginner' %}info{% else %}secondary{% endif %}">
                                        {{ participant.skill_level }}
                                    </span>
                                </div>
                                <div class="skill-edit" style="display: none;">
                                    <select class="form-select form-select-sm skill-input">
                                        <option value="Beginner" {% if participant.skill_level == 'Beginner' %}selected{% endif %}>Beginner</option>
                                        <option value="Intermediate" {% if participant.skill_level == 'Intermediate' %}selected{% endif %}>Intermediate</option>
                                        <option value="Expert" {% if participant.skill_level == 'Expert' %}selected{% endif %}>Expert</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="experience-display">{{ participant.experience }}</div>
                                <div class="experience-edit" style="display: none;">
                                    <input type="text" class="form-control form-control-sm experience-input" value="{{ participant.experience or '' }}">
                                </div>
                            </td>
                            <td>
                                <div class="equipment-display">
                                    {% if participant.has_binoculars %}<i class="bi bi-binoculars" title="Has binoculars"></i>{% endif %}
                                    {% if participant.spotting_scope %}<img src="{{ url_for('static', filename='icons/scope.svg') }}" alt="Spotting scope" title="Can bring spotting scope" class="scope-icon ms-1" style="width: 16px; height: 16px; vertical-align: text-bottom;">{% endif %}
                                    {% if not participant.has_binoculars and not participant.spotting_scope %}<span class="text-muted">None</span>{% endif %}
                                </div>
                                <div class="equipment-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input has-binoculars-input" type="checkbox" {% if participant.has_binoculars %}checked{% endif %}>
                                        <label class="form-check-label small">Binoculars</label>
                                    </div>
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input spotting-scope-input" type="checkbox" {% if participant.spotting_scope %}checked{% endif %}>
                                        <label class="form-check-label small">Scope</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="notes-display">
                                    {% if participant.notes_to_organizers %}
                                        <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ participant.notes_to_organizers|e }}">
                                            {{ participant.notes_to_organizers[:50]|e }}{% if participant.notes_to_organizers|length > 50 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </div>
                                <div class="notes-edit" style="display: none;">
                                    <textarea class="form-control form-control-sm notes-input" rows="2" placeholder="Notes to organizers">{{ participant.notes_to_organizers or '' }}</textarea>
                                </div>
                            </td>
                            <td>
                                <div class="leadership-display">
                                    {% if participant.interested_in_leadership %}
                                        <span class="badge bg-warning">Interested</span>
                                    {% else %}
                                        <span class="text-muted">No</span>
                                    {% endif %}
                                </div>
                                <div class="leadership-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input leadership-input" type="checkbox" {% if participant.interested_in_leadership %}checked{% endif %}>
                                        <label class="form-check-label small">Interested</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="scribe-display">
                                    {% if participant.get('interested_in_scribe') %}
                                        <span class="badge bg-info">Interested</span>
                                    {% else %}
                                        <span class="text-muted">No</span>
                                    {% endif %}
                                </div>
                                <div class="scribe-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input scribe-input" type="checkbox" {% if participant.get('interested_in_scribe') %}checked{% endif %}>
                                        <label class="form-check-label small">Interested</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm action-buttons" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-edit" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal"
                                            data-participant-id="{{ participant.id }}"
                                            data-participant-name="{{ participant.first_name|e }} {{ participant.last_name|e }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm edit-buttons" style="display: none;" role="group">
                                    <button type="button" class="btn btn-success btn-save" title="Save">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-cancel" title="Cancel">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="participantName"></strong>?</p>
                <p class="text-muted">This action cannot be undone. The participant will be logged in the removal history.</p>
                
                <div class="mb-3">
                    <label for="deleteReason" class="form-label">Reason for removal (optional)</label>
                    <textarea class="form-control" id="deleteReason" rows="2" placeholder="e.g., Duplicate registration, requested withdrawal"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ selected_year }}">
                    <input type="hidden" name="reason" id="deleteReasonInput">
                    <button type="submit" class="btn btn-danger">Delete Participant</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body text-center">
        <h5>No Participants</h5>
        <p class="text-muted">No participants registered for {{ selected_year }} yet.</p>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">Registration Page</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Handle delete modal
const deleteModal = document.getElementById('deleteModal');
if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const participantId = button.getAttribute('data-participant-id');
        const participantName = button.getAttribute('data-participant-name');

        const modalTitle = deleteModal.querySelector('#participantName');
        const deleteForm = deleteModal.querySelector('#deleteForm');

        modalTitle.textContent = participantName;
        deleteForm.action = '/admin/delete_participant/' + participantId;
    });

    // Handle reason input
    const reasonTextarea = deleteModal.querySelector('#deleteReason');
    const reasonInput = deleteModal.querySelector('#deleteReasonInput');

    reasonTextarea.addEventListener('input', function() {
        reasonInput.value = this.value;
    });
}

// Inline editing functionality for participants table
document.addEventListener('DOMContentLoaded', function() {
    // Handle edit button clicks
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            enableEditMode(row);
        });
    });

    // Handle save button clicks
    document.querySelectorAll('.btn-save').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            saveParticipantChanges(row);
        });
    });

    // Handle cancel button clicks
    document.querySelectorAll('.btn-cancel').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            disableEditMode(row);
        });
    });

    function enableEditMode(row) {
        // Hide display elements and show edit elements
        row.querySelectorAll('.name-display, .email-display, .phone-display, .skill-display, .experience-display, .equipment-display, .notes-display, .leadership-display, .scribe-display').forEach(el => {
            el.style.display = 'none';
        });
        row.querySelectorAll('.name-edit, .email-edit, .phone-edit, .skill-edit, .experience-edit, .equipment-edit, .notes-edit, .leadership-edit, .scribe-edit').forEach(el => {
            el.style.display = 'block';
        });

        // Switch buttons
        row.querySelector('.action-buttons').style.display = 'none';
        row.querySelector('.edit-buttons').style.display = 'block';
    }

    function disableEditMode(row) {
        // Show display elements and hide edit elements
        row.querySelectorAll('.name-display, .email-display, .phone-display, .skill-display, .experience-display, .equipment-display, .notes-display, .leadership-display, .scribe-display').forEach(el => {
            el.style.display = 'block';
        });
        row.querySelectorAll('.name-edit, .email-edit, .phone-edit, .skill-edit, .experience-edit, .equipment-edit, .notes-edit, .leadership-edit, .scribe-edit').forEach(el => {
            el.style.display = 'none';
        });

        // Switch buttons back
        row.querySelector('.action-buttons').style.display = 'block';
        row.querySelector('.edit-buttons').style.display = 'none';
    }

    function saveParticipantChanges(row) {
        const participantId = row.dataset.participantId;
        const formData = {
            participant_id: participantId,
            first_name: row.querySelector('.first-name-input').value.trim(),
            last_name: row.querySelector('.last-name-input').value.trim(),
            email: row.querySelector('.email-input').value.trim(),
            phone: row.querySelector('.phone-input').value.trim(),
            phone2: row.querySelector('.phone2-input').value.trim(),
            skill_level: row.querySelector('.skill-input').value,
            experience: row.querySelector('.experience-input').value.trim(),
            notes_to_organizers: row.querySelector('.notes-input').value.trim(),
            has_binoculars: row.querySelector('.has-binoculars-input').checked,
            spotting_scope: row.querySelector('.spotting-scope-input').checked,
            interested_in_leadership: row.querySelector('.leadership-input').checked,
            interested_in_scribe: row.querySelector('.scribe-input').checked,
            year: {{ selected_year }},
            csrf_token: '{{ csrf_token() }}'
        };

        // Basic validation
        if (!formData.first_name || !formData.last_name || !formData.email) {
            alert('Please fill in all required fields (First Name, Last Name, Email).');
            return;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            alert('Please enter a valid email address.');
            return;
        }

        // Show loading state
        const saveButton = row.querySelector('.btn-save');
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        saveButton.disabled = true;

        // Send AJAX request
        fetch('{{ url_for("admin.edit_participant") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.csrf_token
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display values
                row.querySelector('.participant-name').textContent = formData.first_name + ' ' + formData.last_name;
                row.querySelector('.email-display a').textContent = formData.email;
                row.querySelector('.email-display a').href = 'mailto:' + formData.email;

                // Update phone display
                const phoneDisplay = row.querySelector('.phone-display');
                let phoneText = formData.phone || 'N/A';
                if (formData.phone2) {
                    phoneText += '<div class="small text-muted">' + formData.phone2 + '</div>';
                }
                phoneDisplay.innerHTML = phoneText;

                // Update skill level display
                const skillDisplay = row.querySelector('.skill-display .badge');
                skillDisplay.textContent = formData.skill_level;
                // Update badge color based on skill level
                skillDisplay.className = 'badge bg-' +
                    (formData.skill_level === 'Expert' ? 'success' :
                     formData.skill_level === 'Intermediate' ? 'primary' :
                     formData.skill_level === 'Beginner' ? 'info' : 'secondary');

                // Update experience display
                row.querySelector('.experience-display').textContent = formData.experience || '';

                // Update equipment display
                const equipmentDisplay = row.querySelector('.equipment-display');
                let equipmentHtml = '';
                if (formData.has_binoculars) {
                    equipmentHtml += '<i class="bi bi-binoculars" title="Has binoculars"></i>';
                }
                if (formData.spotting_scope) {
                    equipmentHtml += '<img src="{{ url_for("static", filename="icons/scope.svg") }}" alt="Spotting scope" title="Can bring spotting scope" class="scope-icon ms-1" style="width: 16px; height: 16px; vertical-align: text-bottom;">';
                }
                if (!formData.has_binoculars && !formData.spotting_scope) {
                    equipmentHtml = '<span class="text-muted">None</span>';
                }
                equipmentDisplay.innerHTML = equipmentHtml;

                // Update notes display
                const notesDisplay = row.querySelector('.notes-display');
                if (formData.notes_to_organizers) {
                    const truncated = formData.notes_to_organizers.length > 50 ? formData.notes_to_organizers.substring(0, 50) + '...' : formData.notes_to_organizers;
                    notesDisplay.innerHTML = '<span class="text-truncate d-inline-block" style="max-width: 150px;" title="' + formData.notes_to_organizers + '">' + truncated + '</span>';
                } else {
                    notesDisplay.innerHTML = '<span class="text-muted">None</span>';
                }

                // Update leadership display
                const leadershipDisplay = row.querySelector('.leadership-display');
                if (formData.interested_in_leadership) {
                    leadershipDisplay.innerHTML = '<span class="badge bg-warning">Interested</span>';
                } else {
                    leadershipDisplay.innerHTML = '<span class="text-muted">No</span>';
                }

                // Update scribe display
                const scribeDisplay = row.querySelector('.scribe-display');
                if (formData.interested_in_scribe) {
                    scribeDisplay.innerHTML = '<span class="badge bg-info">Interested</span>';
                } else {
                    scribeDisplay.innerHTML = '<span class="text-muted">No</span>';
                }

                // Exit edit mode
                disableEditMode(row);

                // Show success message
                alert('Participant updated successfully!');
            } else {
                alert('Error updating participant: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating participant. Please try again.');
        })
        .finally(() => {
            // Reset button state
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        });
    }
});
</script>
{% endblock %}