{# Updated by Claude AI on 2025-12-16 #}
{% extends "base.html" %}

{% block title %}All Participants - {{ count_event_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>All Participants</h1>
    <div>
        <span class="badge bg-info">{{ selected_year }}</span>
        {% if current_user.email %}
        <span class="text-muted">{{ current_user.email }}</span>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary ms-2">Logout</a>
        {% endif %}
    </div>
</div>

<!-- Navigation breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard', year=selected_year) }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">All Participants</li>
    </ol>
</nav>

<!-- Year Tabs Navigation -->
{% if available_years and available_years|length > 1 %}
<ul class="nav nav-tabs mb-4" role="tablist">
    {% for year in available_years %}
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if year == selected_year %}active{% endif %} {% if year < current_year %}text-warning{% endif %}"
           href="{{ url_for('admin.participants', year=year) }}"
           role="tab">
            {{ year }}
            {% if year < current_year %}<i class="bi bi-archive ms-1" title="Historical data"></i>{% endif %}
        </a>
    </li>
    {% endfor %}
</ul>
{% endif %}

<!-- Historical Data Warning Banner -->
{% if is_historical %}
<div class="alert alert-warning" role="alert">
    <i class="bi bi-info-circle-fill"></i>
    <strong>Historical Data ({{ selected_year }})</strong> - This is read-only data from a previous year. Edit and delete actions are disabled.
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('admin.unassigned', year=selected_year) }}" class="btn btn-warning me-2">Manage Unassigned</a>
                <a href="{{ url_for('admin.leaders', year=selected_year) }}" class="btn btn-info me-2">Manage Leaders</a>
                <a href="{{ url_for('admin.export_csv', year=selected_year) }}" class="btn btn-success">Export CSV</a>
            </div>
        </div>
    </div>
</div>

<!-- Area Navigation -->
{% set areas_with_participants = participants | groupby('preferred_area') | list %}
{% if areas_with_participants %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Jump to Area</h5>
        <div class="d-flex flex-wrap gap-2">
            {% for area_code, area_participants in areas_with_participants %}
            {% set area_label = 'UNASSIGNED' if area_code == 'UNASSIGNED' else 'Area ' + area_code %}
            {% set area_list = area_participants|list %}
            {% set field_count = area_list|selectattr('status', 'equalto', 'active')|selectattr('participation_type', 'equalto', 'regular')|list|length %}
            {% set feeder_count = area_list|selectattr('status', 'equalto', 'active')|selectattr('participation_type', 'equalto', 'FEEDER')|list|length %}
            {% set withdrawn_count = area_list|selectattr('status', 'equalto', 'withdrawn')|list|length %}
            <a href="#area-{{ area_code }}" class="btn btn-outline-primary btn-sm">
                {{ area_label }} ({{ field_count }} field{% if feeder_count > 0 %}, {{ feeder_count }} feeder{% endif %}{% if withdrawn_count > 0 %}, {{ withdrawn_count }} withdrawn{% endif %})
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Participants by Area -->
{% if participants %}
    {# Group participants by area and sort areas alphabetically #}
    {% for area_code in participants | map(attribute='preferred_area') | list | unique | sort %}
    {% set area_participants = participants | selectattr('preferred_area', 'equalto', area_code) | list %}
    {% if area_participants %}
    <div id="area-{{ area_code }}" class="card mb-4{% if is_historical %} bg-warning bg-opacity-10{% endif %}">
        <div class="card-header{% if is_historical %} bg-warning bg-opacity-25{% endif %}">
            <h5 class="mb-0">
                {% set field_count = area_participants|selectattr('status', 'equalto', 'active')|selectattr('participation_type', 'equalto', 'regular')|list|length %}
                {% set feeder_count = area_participants|selectattr('status', 'equalto', 'active')|selectattr('participation_type', 'equalto', 'FEEDER')|list|length %}
                {% set withdrawn_count = area_participants|selectattr('status', 'equalto', 'withdrawn')|list|length %}
                {% if area_code == 'UNASSIGNED' %}
                    UNASSIGNED ({{ field_count }} field{% if feeder_count > 0 %}, {{ feeder_count }} feeder{% endif %}{% if withdrawn_count > 0 %}, {{ withdrawn_count }} withdrawn{% endif %})
                {% else %}
                    Area {{ area_code }} ({{ field_count }} field{% if feeder_count > 0 %}, {{ feeder_count }} feeder{% endif %}{% if withdrawn_count > 0 %}, {{ withdrawn_count }} withdrawn{% endif %})
                    {% if area_leaders.get(area_code) %}
                        {% for leader in area_leaders[area_code] %}
                            <br><small class="text-muted">
                                â€¢ Leader: {{ leader.first_name|e }} {{ leader.last_name|e }}
                                <i class="bi bi-envelope-fill"></i> <a href="mailto:{{ leader.email|e }}">{{ leader.email|e }}</a>
                                <i class="bi bi-telephone-fill"></i> {{ leader.phone|e }}
                            </small>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Cell Phone</th>
                            <th>Skill Level</th>
                            <th>Experience</th>
                            <th>Equipment</th>
                            <th>Notes</th>
                            <th>Leader</th>
                            <th>Scribe</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Sort participants: active regular first, then FEEDER, then withdrawn - all by first name #}
                        {% set active_participants = area_participants | selectattr('status', 'equalto', 'active') | list %}
                        {% set withdrawn_participants = area_participants | selectattr('status', 'equalto', 'withdrawn') | list %}
                        {% set regular_active = active_participants | selectattr('participation_type', 'ne', 'FEEDER') | sort(attribute='first_name') | list %}
                        {% set feeder_active = active_participants | selectattr('participation_type', 'equalto', 'FEEDER') | sort(attribute='first_name') | list %}
                        {% set withdrawn_sorted = withdrawn_participants | sort(attribute='first_name') | list %}
                        {% set sorted_participants = regular_active + feeder_active + withdrawn_sorted %}
                        {% for participant in sorted_participants %}
                        <tr{% if participant.get('status') == 'withdrawn' %} class="table-warning"{% elif participant.get('participation_type') == 'FEEDER' %} class="table-info"{% endif %} data-participant-id="{{ participant.id }}">
                            <td>
                                <div class="name-display">
                                    <strong class="participant-name">{{ participant.first_name|e }} {{ participant.last_name|e }}</strong>
                                    {% if participant.is_leader %}
                                        <span class="badge bg-success ms-1">Leader</span>
                                    {% endif %}
                                    {% if participant.get('participation_type') == 'FEEDER' %}
                                        <div class="small text-muted">FEEDER</div>
                                    {% endif %}
                                    {% if participant.get('status') == 'withdrawn' %}
                                        <div class="small text-warning fw-bold">WITHDRAWN</div>
                                    {% endif %}
                                </div>
                                <div class="name-edit" style="display: none;">
                                    <div class="d-flex gap-1">
                                        <input type="text" class="form-control form-control-sm first-name-input" value="{{ participant.first_name|e }}" placeholder="First name">
                                        <input type="text" class="form-control form-control-sm last-name-input" value="{{ participant.last_name|e }}" placeholder="Last name">
                                    </div>
                                    {% if participant.is_leader %}
                                        <span class="badge bg-success ms-1">Leader</span>
                                    {% endif %}
                                    {% if participant.get('participation_type') == 'FEEDER' %}
                                        <div class="small text-muted">FEEDER</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="email-display">
                                    <a href="mailto:{{ participant.email|e }}">{{ participant.email|e }}</a>
                                </div>
                                <div class="email-edit" style="display: none;">
                                    <input type="email" class="form-control form-control-sm email-input" value="{{ participant.email|e }}">
                                </div>
                            </td>
                            <td>
                                <div class="phone-display">
                                    {{ participant.phone|e or 'N/A' }}
                                    {% if participant.get('phone2') %}
                                        <div class="small text-muted">{{ participant.phone2|e }}</div>
                                    {% endif %}
                                </div>
                                <div class="phone-edit" style="display: none;">
                                    <input type="tel" class="form-control form-control-sm phone-input mb-1" style="min-width: 140px;" value="{{ participant.phone or '' }}" placeholder="Cell phone">
                                    <input type="tel" class="form-control form-control-sm phone2-input" style="min-width: 140px;" value="{{ participant.phone2 or '' }}" placeholder="Secondary phone">
                                </div>
                            </td>
                            <td>
                                <div class="skill-display">
                                    <span class="badge bg-{% if participant.skill_level == 'Expert' %}success{% elif participant.skill_level == 'Intermediate' %}primary{% elif participant.skill_level == 'Beginner' %}info{% else %}secondary{% endif %}">
                                        {{ participant.skill_level }}
                                    </span>
                                </div>
                                <div class="skill-edit" style="display: none;">
                                    <select class="form-select form-select-sm skill-input">
                                        <option value="Newbie" {% if participant.skill_level == 'Newbie' %}selected{% endif %}>Newbie</option>
                                        <option value="Beginner" {% if participant.skill_level == 'Beginner' %}selected{% endif %}>Beginner</option>
                                        <option value="Intermediate" {% if participant.skill_level == 'Intermediate' %}selected{% endif %}>Intermediate</option>
                                        <option value="Expert" {% if participant.skill_level == 'Expert' %}selected{% endif %}>Expert</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="experience-display">{{ participant.experience }}</div>
                                <div class="experience-edit" style="display: none;">
                                    <select class="form-select form-select-sm experience-input">
                                        <option value="None" {% if participant.experience == 'None' %}selected{% endif %}>None</option>
                                        <option value="1-2 counts" {% if participant.experience == '1-2 counts' %}selected{% endif %}>1-2 counts</option>
                                        <option value="3+ counts" {% if participant.experience == '3+ counts' %}selected{% endif %}>3+ counts</option>
                                    </select>
                                </div>
                            </td>
                            <td>
                                <div class="equipment-display">
                                    {% if participant.has_binoculars %}<i class="bi bi-binoculars" title="Has binoculars"></i>{% endif %}
                                    {% if participant.spotting_scope %}<img src="{{ url_for('static', filename='icons/scope.svg') }}" alt="Spotting scope" title="Can bring spotting scope" class="scope-icon ms-1" style="width: 16px; height: 16px; vertical-align: text-bottom;">{% endif %}
                                    {% if not participant.has_binoculars and not participant.spotting_scope %}<span class="text-muted">None</span>{% endif %}
                                </div>
                                <div class="equipment-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input has-binoculars-input" type="checkbox" {% if participant.has_binoculars %}checked{% endif %}>
                                        <label class="form-check-label small">Binoculars</label>
                                    </div>
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input spotting-scope-input" type="checkbox" {% if participant.spotting_scope %}checked{% endif %}>
                                        <label class="form-check-label small">Scope</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="notes-display">
                                    {% if participant.notes_to_organizers %}
                                        {{ participant.notes_to_organizers|e }}
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </div>
                                <div class="notes-edit" style="display: none;">
                                    <textarea class="form-control form-control-sm notes-input" rows="2" placeholder="Notes to organizers">{{ participant.notes_to_organizers or '' }}</textarea>
                                </div>
                            </td>
                            <td>
                                <div class="leadership-display">
                                    {% if participant.interested_in_leadership %}
                                        <span class="badge bg-warning">Interested</span>
                                    {% else %}
                                        <span class="text-muted">No</span>
                                    {% endif %}
                                </div>
                                <div class="leadership-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input leadership-input" type="checkbox" {% if participant.interested_in_leadership %}checked{% endif %}>
                                        <label class="form-check-label small">Interested</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="scribe-display">
                                    {% if participant.get('interested_in_scribe') %}
                                        <span class="badge bg-info">Interested</span>
                                    {% else %}
                                        <span class="text-muted">No</span>
                                    {% endif %}
                                </div>
                                <div class="scribe-edit" style="display: none;">
                                    <div class="form-check form-check-sm">
                                        <input class="form-check-input scribe-input" type="checkbox" {% if participant.get('interested_in_scribe') %}checked{% endif %}>
                                        <label class="form-check-label small">Interested</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if not is_historical %}
                                <div class="btn-group btn-group-sm action-buttons" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-edit" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% if participant.get('status') != 'withdrawn' %}
                                    <button type="button" class="btn btn-outline-warning btn-reassign" title="Reassign to different area"
                                            data-participant-id="{{ participant.id }}"
                                            data-participant-name="{{ participant.first_name|e }} {{ participant.last_name|e }}"
                                            data-first-name="{{ participant.first_name|e }}"
                                            data-last-name="{{ participant.last_name|e }}"
                                            data-email="{{ participant.email|e }}"
                                            data-current-area="{{ area_code }}"
                                            data-is-leader="{{ participant.is_leader|lower }}">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    {% endif %}
                                    {% if participant.get('status') == 'withdrawn' %}
                                    <form method="POST" action="{{ url_for('admin.reactivate_participant', participant_id=participant.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="year" value="{{ selected_year }}">
                                        <button type="submit" class="btn btn-outline-success btn-sm" title="Reactivate participant">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#withdrawalModal"
                                            data-participant-id="{{ participant.id }}"
                                            data-participant-name="{{ participant.first_name|e }} {{ participant.last_name|e }}"
                                            title="Withdraw participant">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal"
                                            data-participant-id="{{ participant.id }}"
                                            data-participant-name="{{ participant.first_name|e }} {{ participant.last_name|e }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm edit-buttons" style="display: none;" role="group">
                                    <button type="button" class="btn btn-success btn-save" title="Save">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-cancel" title="Cancel">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="reassign-controls" style="display: none;">
                                    <select class="form-select form-select-sm d-inline-block reassign-area-select" style="width: auto;">
                                        <option value="">Select Area</option>
                                        {% for area in all_areas %}
                                        <option value="{{ area }}">Area {{ area }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-success btn-sm btn-confirm-reassign" title="Confirm reassignment">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm btn-cancel-reassign" title="Cancel">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                {% else %}
                                <span class="text-muted small">Read-only</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

<!-- Leader Reassignment Modal -->
<div class="modal fade" id="leaderReassignModal" tabindex="-1" aria-labelledby="leaderReassignModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leaderReassignModalLabel">Reassign Leader</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="leaderReassignMessage"></p>
                <p class="fw-bold">Move as:</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" id="moveAsTeamMember">Team Member</button>
                <button type="button" class="btn btn-primary" id="moveAsLeader">Leader</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Confirmation Modal -->
<div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawalModalLabel">Withdraw Participant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to withdraw <strong id="withdrawalParticipantName"></strong>?</p>
                <p class="text-muted">They will be excluded from team rosters but their contact information will be retained for future recruitment.</p>

                <div class="mb-3">
                    <label for="withdrawalReason" class="form-label">Reason for withdrawal (optional)</label>
                    <textarea class="form-control" id="withdrawalReason" rows="3" placeholder="e.g., Family commitment, health reasons, schedule conflict"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="withdrawalForm" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ selected_year }}">
                    <input type="hidden" name="reason" id="withdrawalReasonInput">
                    <button type="submit" class="btn btn-warning">Withdraw Participant</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="participantName"></strong>?</p>
                <p class="text-muted">This action cannot be undone. The participant will be logged in the removal history.</p>
                
                <div class="mb-3">
                    <label for="deleteReason" class="form-label">Reason for removal (optional)</label>
                    <textarea class="form-control" id="deleteReason" rows="2" placeholder="e.g., Duplicate registration, requested withdrawal"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ selected_year }}">
                    <input type="hidden" name="reason" id="deleteReasonInput">
                    <button type="submit" class="btn btn-danger">Delete Participant</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body text-center">
        <h5>No Participants</h5>
        <p class="text-muted">No participants registered for {{ selected_year }} yet.</p>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">Registration Page</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Handle delete modal
const deleteModal = document.getElementById('deleteModal');
if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const participantId = button.getAttribute('data-participant-id');
        const participantName = button.getAttribute('data-participant-name');

        const modalTitle = deleteModal.querySelector('#participantName');
        const deleteForm = deleteModal.querySelector('#deleteForm');

        modalTitle.textContent = participantName;
        deleteForm.action = '/admin/delete_participant/' + participantId;
    });

    // Handle reason input
    const reasonTextarea = deleteModal.querySelector('#deleteReason');
    const reasonInput = deleteModal.querySelector('#deleteReasonInput');

    reasonTextarea.addEventListener('input', function() {
        reasonInput.value = this.value;
    });
}

// Handle withdrawal modal
const withdrawalModal = document.getElementById('withdrawalModal');
if (withdrawalModal) {
    withdrawalModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const participantId = button.getAttribute('data-participant-id');
        const participantName = button.getAttribute('data-participant-name');

        const modalTitle = withdrawalModal.querySelector('#withdrawalParticipantName');
        const withdrawalForm = withdrawalModal.querySelector('#withdrawalForm');

        modalTitle.textContent = participantName;
        withdrawalForm.action = '/admin/withdraw_participant/' + participantId;
    });

    // Handle reason input
    const withdrawalReasonTextarea = withdrawalModal.querySelector('#withdrawalReason');
    const withdrawalReasonInput = withdrawalModal.querySelector('#withdrawalReasonInput');

    withdrawalReasonTextarea.addEventListener('input', function() {
        withdrawalReasonInput.value = this.value;
    });
}

// Inline editing functionality for participants table
document.addEventListener('DOMContentLoaded', function() {
    // Handle edit button clicks
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            enableEditMode(row);
        });
    });

    // Handle save button clicks
    document.querySelectorAll('.btn-save').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            saveParticipantChanges(row);
        });
    });

    // Handle cancel button clicks
    document.querySelectorAll('.btn-cancel').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            disableEditMode(row);
        });
    });

    function enableEditMode(row) {
        // Hide display elements and show edit elements
        row.querySelectorAll('.name-display, .email-display, .phone-display, .skill-display, .experience-display, .equipment-display, .notes-display, .leadership-display, .scribe-display').forEach(el => {
            el.style.display = 'none';
        });
        row.querySelectorAll('.name-edit, .email-edit, .phone-edit, .skill-edit, .experience-edit, .equipment-edit, .notes-edit, .leadership-edit, .scribe-edit').forEach(el => {
            el.style.display = 'block';
        });

        // Switch buttons
        row.querySelector('.action-buttons').style.display = 'none';
        row.querySelector('.edit-buttons').style.display = 'block';
    }

    function disableEditMode(row) {
        // Show display elements and hide edit elements
        row.querySelectorAll('.name-display, .email-display, .phone-display, .skill-display, .experience-display, .equipment-display, .notes-display, .leadership-display, .scribe-display').forEach(el => {
            el.style.display = 'block';
        });
        row.querySelectorAll('.name-edit, .email-edit, .phone-edit, .skill-edit, .experience-edit, .equipment-edit, .notes-edit, .leadership-edit, .scribe-edit').forEach(el => {
            el.style.display = 'none';
        });

        // Switch buttons back
        row.querySelector('.action-buttons').style.display = 'block';
        row.querySelector('.edit-buttons').style.display = 'none';
    }

    function saveParticipantChanges(row) {
        const participantId = row.dataset.participantId;
        const formData = {
            participant_id: participantId,
            first_name: row.querySelector('.first-name-input').value.trim(),
            last_name: row.querySelector('.last-name-input').value.trim(),
            email: row.querySelector('.email-input').value.trim(),
            phone: row.querySelector('.phone-input').value.trim(),
            phone2: row.querySelector('.phone2-input').value.trim(),
            skill_level: row.querySelector('.skill-input').value,
            experience: row.querySelector('.experience-input').value.trim(),
            notes_to_organizers: row.querySelector('.notes-input').value.trim(),
            has_binoculars: row.querySelector('.has-binoculars-input').checked,
            spotting_scope: row.querySelector('.spotting-scope-input').checked,
            interested_in_leadership: row.querySelector('.leadership-input').checked,
            interested_in_scribe: row.querySelector('.scribe-input').checked,
            year: {{ selected_year }},
            csrf_token: '{{ csrf_token() }}'
        };

        // Basic validation
        if (!formData.first_name || !formData.last_name || !formData.email) {
            alert('Please fill in all required fields (First Name, Last Name, Email).');
            return;
        }

        // Email validation using shared validator
        if (!validateEmailFormat(formData.email)) {
            alert('Please enter a valid email address.');
            return;
        }

        // Show loading state
        const saveButton = row.querySelector('.btn-save');
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        saveButton.disabled = true;

        // Send AJAX request
        fetch('{{ url_for("admin.edit_participant") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.csrf_token
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display values
                row.querySelector('.participant-name').textContent = formData.first_name + ' ' + formData.last_name;
                row.querySelector('.email-display a').textContent = formData.email;
                row.querySelector('.email-display a').href = 'mailto:' + formData.email;

                // Update phone display
                const phoneDisplay = row.querySelector('.phone-display');
                let phoneText = formData.phone || 'N/A';
                if (formData.phone2) {
                    phoneText += '<div class="small text-muted">' + formData.phone2 + '</div>';
                }
                phoneDisplay.innerHTML = phoneText;

                // Update skill level display
                const skillDisplay = row.querySelector('.skill-display .badge');
                skillDisplay.textContent = formData.skill_level;
                // Update badge color based on skill level
                skillDisplay.className = 'badge bg-' +
                    (formData.skill_level === 'Expert' ? 'success' :
                     formData.skill_level === 'Intermediate' ? 'primary' :
                     formData.skill_level === 'Beginner' ? 'info' : 'secondary');

                // Update experience display
                row.querySelector('.experience-display').textContent = formData.experience || '';

                // Update equipment display
                const equipmentDisplay = row.querySelector('.equipment-display');
                let equipmentHtml = '';
                if (formData.has_binoculars) {
                    equipmentHtml += '<i class="bi bi-binoculars" title="Has binoculars"></i>';
                }
                if (formData.spotting_scope) {
                    equipmentHtml += '<img src="{{ url_for("static", filename="icons/scope.svg") }}" alt="Spotting scope" title="Can bring spotting scope" class="scope-icon ms-1" style="width: 16px; height: 16px; vertical-align: text-bottom;">';
                }
                if (!formData.has_binoculars && !formData.spotting_scope) {
                    equipmentHtml = '<span class="text-muted">None</span>';
                }
                equipmentDisplay.innerHTML = equipmentHtml;

                // Update notes display
                const notesDisplay = row.querySelector('.notes-display');
                if (formData.notes_to_organizers) {
                    notesDisplay.textContent = formData.notes_to_organizers;
                } else {
                    notesDisplay.innerHTML = '<span class="text-muted">None</span>';
                }

                // Update leadership display
                const leadershipDisplay = row.querySelector('.leadership-display');
                if (formData.interested_in_leadership) {
                    leadershipDisplay.innerHTML = '<span class="badge bg-warning">Interested</span>';
                } else {
                    leadershipDisplay.innerHTML = '<span class="text-muted">No</span>';
                }

                // Update scribe display
                const scribeDisplay = row.querySelector('.scribe-display');
                if (formData.interested_in_scribe) {
                    scribeDisplay.innerHTML = '<span class="badge bg-info">Interested</span>';
                } else {
                    scribeDisplay.innerHTML = '<span class="text-muted">No</span>';
                }

                // Exit edit mode
                disableEditMode(row);

                // Show success message
                alert('Participant updated successfully!');
            } else {
                alert('Error updating participant: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating participant. Please try again.');
        })
        .finally(() => {
            // Reset button state
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        });
    }

    // Reassignment functionality
    document.querySelectorAll('.btn-reassign').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');

            // Hide action buttons, show reassign controls
            row.querySelector('.action-buttons').style.display = 'none';
            row.querySelector('.reassign-controls').style.display = 'block';
        });
    });

    document.querySelectorAll('.btn-cancel-reassign').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');

            // Show action buttons, hide reassign controls
            row.querySelector('.action-buttons').style.display = 'block';
            row.querySelector('.reassign-controls').style.display = 'none';

            // Reset dropdown
            row.querySelector('.reassign-area-select').value = '';
        });
    });

    document.querySelectorAll('.btn-confirm-reassign').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const reassignButton = row.querySelector('.btn-reassign');
            const participantId = reassignButton.dataset.participantId;
            const participantName = reassignButton.dataset.participantName;
            const firstName = reassignButton.dataset.firstName;
            const lastName = reassignButton.dataset.lastName;
            const email = reassignButton.dataset.email;
            const currentArea = reassignButton.dataset.currentArea;
            const isLeader = reassignButton.dataset.isLeader === 'true';
            const newArea = row.querySelector('.reassign-area-select').value;

            if (!newArea) {
                alert('Please select an area.');
                return;
            }

            if (newArea === currentArea) {
                alert('Participant is already in Area ' + currentArea + '.');
                return;
            }

            // If participant is a leader, show modal to ask about leadership
            if (isLeader) {
                const modal = new bootstrap.Modal(document.getElementById('leaderReassignModal'));
                document.getElementById('leaderReassignMessage').textContent =
                    `Moving ${participantName} from Area ${currentArea} to Area ${newArea}.`;

                // Store context for button handlers
                const reassignButton = this;

                // Handler for "Move as Leader" button
                document.getElementById('moveAsLeader').onclick = function() {
                    modal.hide();
                    reassignButton.disabled = true;
                    reassignButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    reassignLeader(participantId, newArea, reassignButton);
                };

                // Handler for "Move as Team Member" button
                document.getElementById('moveAsTeamMember').onclick = function() {
                    modal.hide();
                    reassignButton.disabled = true;
                    reassignButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    reassignParticipant(participantId, firstName, lastName, email, newArea, reassignButton);
                };

                modal.show();
            } else {
                // Non-leader: just move them
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                reassignParticipant(participantId, firstName, lastName, email, newArea, this);
            }
        });
    });

    function reassignLeader(participantId, newArea, button) {
        const formData = new FormData();
        formData.append('participant_id', participantId);
        formData.append('area_code', newArea);
        formData.append('year', {{ selected_year }});
        formData.append('csrf_token', '{{ csrf_token() }}');

        fetch('{{ url_for("admin.assign_leader") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                // Flask redirected - means success with flash message
                window.location.reload();
            } else {
                // Check if it's an error
                return response.text().then(text => {
                    alert('Error reassigning leader. Please check the error message on the page after reload.');
                    window.location.reload();
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error reassigning participant. Please try again.');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-check"></i>';
        });
    }

    function reassignParticipant(participantId, firstName, lastName, email, newArea, button) {
        const formData = {
            participant_id: participantId,
            first_name: firstName,
            last_name: lastName,
            email: email,
            preferred_area: newArea,
            year: {{ selected_year }},
            csrf_token: '{{ csrf_token() }}'
        };

        fetch('{{ url_for("admin.edit_participant") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.csrf_token
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Participant reassigned successfully. Reloading page...');
                window.location.reload();
            } else {
                alert('Error reassigning participant: ' + (data.message || 'Unknown error'));
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check"></i>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error reassigning participant. Please try again.');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-check"></i>';
        });
    }
});
</script>
{% endblock %}