# Developer Guide - Christmas Bird Count Registration System
<!-- Created by Claude AI on 2025-10-10 -->

This guide helps developers set up a development environment, understand the codebase, and contribute to the project.

## <h1 style="color: red;">CAUTION</h1>
<em style="color: red;">All original code and much of the documentation was generated by Claude.ai in response to prompts from Harvey Dueck.

Like every AI I've tried, Claude is prone to making exaggerated claims, stating that a test suite for a single feature
is "comprehensive", that some very sloppy code is "professional", or that something is "production ready" when it hasn't 
been tested yet.  Don't trust such value judgements in documentation
or code comments.  As of 10.10.2025 when I'm checking this in, I haven't yet had time to carefully review the documentation.
It's included in the hope that it will be useful, even if it's incomplete and occasionally inaccurate.
</em>

## Table of Contents

- [Getting Started](#getting-started)
- [Development Environment Setup](#development-environment-setup)
- [Architecture Overview](#architecture-overview)
- [Key Documentation](#key-documentation)
- [Development Workflow](#development-workflow)
- [Testing](#testing)
- [Deployment](#deployment)
- [Contributing](#contributing)
- [Common Development Tasks](#common-development-tasks)

## Getting Started

This application is a Flask-based web system deployed on Google Cloud Run with Firestore database. It's designed to be configuration-driven for easy adaptation by different bird count clubs.

**Prerequisites:**
- Python 3.13+
- Google Cloud account with project access
- Git
- Text editor or IDE (VS Code, PyCharm, etc.)

**Recommended Knowledge:**
- Python and Flask framework
- Google Cloud Platform (Cloud Run, Firestore, Secret Manager)
- HTML/CSS/JavaScript (Bootstrap, Leaflet.js)
- OAuth 2.0 authentication
- NoSQL databases (Firestore)

## Development Environment Setup

### 1. Clone the Repository

```bash
git clone https://github.com/naturevancouver/christmas-bird-count-registration.git
cd christmas-bird-count-registration
```

### 2. Install Python Dependencies

```bash
# Create virtual environment
python -m venv .venv

# Activate virtual environment
# On Windows:
.venv\Scripts\activate
# On macOS/Linux:
source .venv/bin/activate

# Install dependencies
pip install -r requirements.txt
```

### 3. Google Cloud Setup

Follow the complete setup instructions in:
- [GCLOUD-SETUP.md](GCLOUD-SETUP.md) - Initial GCP project configuration
- [DEPLOYMENT.md](DEPLOYMENT.md) - Deployment process

**Quick summary:**
```bash
# Authenticate
gcloud auth login
gcloud config set project YOUR-PROJECT-ID

# Enable required APIs
gcloud services enable run.googleapis.com
gcloud services enable firestore.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable secretmanager.googleapis.com
```

### 4. Create Firestore Databases

```bash
# Install utility dependencies
pip install -r utils/requirements.txt

# Create test and production databases
python utils/setup_databases.py
```

This creates:
- `cbc-test` - Development/testing database
- `cbc-register` - Production database

### 5. Configure OAuth

Follow [OAUTH-SETUP.md](OAUTH-SETUP.md) to:
1. Create OAuth consent screen
2. Create OAuth client credentials
3. Store credentials in Google Secret Manager
4. Publish consent screen

### 6. Local Development

**Note**: The application **cannot run locally** because it requires Google Cloud services (Firestore, Secret Manager) that are not configured for local development. All development and testing must be done using the deployed test server (`cbc-test`).

**Development workflow:**
1. Make code changes locally
2. Deploy to test server: `./deploy.sh test`
3. Test at `https://cbc-test.yourclub.org`
4. Review logs: `gcloud run services logs read cbc-test --region=us-west1`

## Architecture Overview

### Application Structure

```
app.py                  # Flask entry point, blueprint registration
config/                 # Configuration files (organization, areas, admins, etc.)
models/                 # Database models (participant, removal log)
routes/                 # Flask blueprints (main, admin, leader, auth, api)
services/               # Business logic (email, security, rate limiting)
templates/              # Jinja2 HTML templates
static/                 # CSS, JavaScript, images, data files
utils/                  # Deployment and setup utilities
tests/                  # Test suite (pytest)
```

### Technology Stack

**Backend:**
- Python 3.13 with Flask framework
- Google Firestore for data persistence
- Google Secret Manager for credentials
- Google OAuth for authentication
- Flask-WTF for CSRF protection
- Flask-Limiter for rate limiting

**Frontend:**
- Bootstrap 5 for responsive UI
- Leaflet.js for interactive maps
- Vanilla JavaScript for form interactions
- Jinja2 templating

**Deployment:**
- Docker containers on Google Cloud Run
- Automated deployment with `deploy.sh`
- Separate test and production environments

### Key Design Patterns

**Configuration-Driven:**
- All organization-specific settings in `config/` directory
- No code changes needed for different clubs
- Dynamic area validation based on configuration

**Year-Based Data:**
- Collections named `participants_2025`, `area_leaders_2025`, etc.
- Automatic year detection and management
- Historical data read-only through UI

**Identity-Based Operations:**
- Unique identification using `(first_name, last_name, email)` tuple
- Supports family members sharing email addresses
- Critical for leader and participant management

**Role-Based Access:**
- Public (no auth) - Registration pages
- Admin (OAuth + whitelist) - Full management access
- Leader (OAuth + database check) - Team roster access

## Key Documentation

### Essential Reading

**[SPECIFICATION.md](SPECIFICATION.md)** - Complete technical specification
- Data models and database schema
- Feature descriptions and workflows
- Security architecture
- API endpoints
- File structure

**[DEPLOYMENT.md](DEPLOYMENT.md)** - Deployment and configuration
- Google Cloud setup
- Environment variables
- Custom domain configuration
- Email scheduler setup
- Troubleshooting

**[EMAIL_SPEC.md](EMAIL_SPEC.md)** - Email notification system
- Email types and triggers
- Template structure
- Scheduler configuration
- Test mode behavior

### Testing Documentation

**[TEST_SUITE_SPEC.md](TEST_SUITE_SPEC.md)** - Test architecture
- Test framework design
- Test accounts and credentials
- Database isolation strategy

**[TEST_SETUP.md](TEST_SETUP.md)** - Test environment setup
**[TESTING.md](TESTING.md)** - Running tests

### Setup Guides

**[GCLOUD-SETUP.md](GCLOUD-SETUP.md)** - Google Cloud initial setup
**[OAUTH-SETUP.md](OAUTH-SETUP.md)** - OAuth authentication
**[BACKUPS.md](BACKUPS.md)** - Automated backup system

## Development Workflow

### Making Changes

1. **Create feature branch:**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make code changes locally**
   - Edit Python, HTML, CSS, or JavaScript files
   - Follow existing code style and patterns
   - Add comments for complex logic

3. **Deploy to test server:**
   ```bash
   ./deploy.sh test
   ```

4. **Test functionality:**
   - Visit `https://cbc-test.yourclub.org`
   - Test your changes thoroughly
   - Check multiple browsers/devices if UI changes

5. **Review logs:**
   ```bash
   gcloud run services logs read cbc-test --region=us-west1 --limit=50
   ```

6. **Iterate as needed**
   - Fix issues found during testing
   - Redeploy and retest

7. **Commit changes:**
   ```bash
   git add .
   git commit -m "Description of changes"
   git push origin feature/your-feature-name
   ```

8. **Create pull request** on GitHub

### Code Style Guidelines

**Python:**
- Follow PEP 8 style guide
- Use descriptive variable and function names
- Add docstrings for functions and classes
- Use type hints where appropriate

**HTML/Jinja2:**
- Escape all user input with `|e` filter
- Use Bootstrap classes for consistent styling
- Include CSRF tokens in all POST forms
- Add timestamp comments when modifying files

**JavaScript:**
- Use modern ES6+ syntax
- Document functions with comments
- Handle errors gracefully
- Validate user input client-side

**General:**
- **Never hardcode organization-specific values** - use `config/organization.py`
- **Never include credentials** in code or documentation
- Add timestamp comments: `# Updated by Claude AI on YYYY-MM-DD`

### Critical Rules

From [CLAUDE.md](../CLAUDE.md):

1. **Security**: Never include passwords, API keys, or credentials in version-controlled files
2. **Configuration**: Use `config/organization.py` for all org-specific values
3. **Utils Directory**: Never place application code in `utils/` (not deployed)
4. **Input Sanitization**: All user inputs must use `services/security.py` functions
5. **Template Escaping**: All user data must use `|e` filter
6. **Identity-Based Operations**: Use `(first_name, last_name, email)` for unique identification
7. **Firestore Queries**: Use modern `FieldFilter` syntax to avoid deprecation warnings

## Testing

### Test Suite

The project uses pytest with cloud environment testing against live Firestore databases.

**Run tests:**
```bash
# Install test dependencies
pip install -r tests/requirements.txt

# Run all tests
pytest tests/ -v

# Run specific test category
pytest tests/ -m identity -v

# Run specific test file
pytest tests/test_family_email_scenarios.py -v
```

**Test configuration:**
- Test accounts stored in Google Secret Manager
- Separate `cbc-test` database for isolation
- Year 2000 used for test data isolation
- See [TESTING.md](TESTING.md) for details

### Generating Test Data

```bash
# Install utility dependencies
pip install -r utils/requirements.txt

# Generate test participants
python utils/generate_test_participants.py 20              # 20 regular + 5 leaders
python utils/generate_test_participants.py 50 --leaders 10 # 50 regular + 10 leaders
python utils/generate_test_participants.py 20 --scribes 5  # 20 regular + 5 leaders + 5 scribes
```

### Manual Testing Checklist

**Registration:**
- [ ] Public registration form loads with map
- [ ] Area selection via map click works
- [ ] Area selection via dropdown works
- [ ] "Wherever needed" option works
- [ ] FEEDER constraints enforced
- [ ] Form validation prevents invalid submissions
- [ ] Success page displays after submission

**Admin Interface:**
- [ ] OAuth login works
- [ ] Dashboard displays statistics correctly
- [ ] Participant management (view, edit, delete, reassign)
- [ ] Leader management (add, edit, delete, promote)
- [ ] Unassigned participant assignment
- [ ] CSV exports work correctly
- [ ] Year selector switches data correctly

**Leader Interface:**
- [ ] OAuth login works for leaders
- [ ] Team roster displays correctly
- [ ] Historical data accessible
- [ ] CSV export works
- [ ] Contact information displays correctly

## Deployment

### Test Deployment

```bash
# Deploy to test environment
./deploy.sh test

# Verify deployment
gcloud run services describe cbc-test --region=us-west1

# Check logs
gcloud run services logs read cbc-test --region=us-west1 --limit=50
```

### Production Deployment

```bash
# Deploy to production
./deploy.sh production

# Or deploy to both
./deploy.sh both
```

**Pre-deployment checklist:**
- [ ] All tests passing
- [ ] Changes tested on test server
- [ ] Breaking changes documented
- [ ] Admin whitelist updated if needed
- [ ] OAuth configuration verified

See [DEPLOYMENT.md](DEPLOYMENT.md) for complete deployment instructions.

## Contributing

### Contribution Process

1. **Fork the repository** on GitHub
2. **Create a feature branch** from `main`
3. **Make your changes** following code style guidelines
4. **Test thoroughly** on test server
5. **Update documentation** as needed
6. **Commit with clear messages** describing changes
7. **Push to your fork** and create pull request
8. **Respond to review feedback** from maintainers

### Pull Request Guidelines

**Include in PR description:**
- What changes were made and why
- How to test the changes
- Any breaking changes or migrations needed
- Screenshots for UI changes
- Related issue numbers

**Before submitting:**
- [ ] Code follows style guidelines
- [ ] Tests pass (if applicable)
- [ ] Documentation updated
- [ ] No credentials or secrets in code
- [ ] Configuration changes documented

### Areas for Contribution

**Features:**
- Additional participant fields
- Enhanced reporting and analytics
- Mobile app development
- Integration with eBird or other platforms

**Improvements:**
- Performance optimization
- UI/UX enhancements
- Accessibility improvements
- Additional tests

**Documentation:**
- User guides and tutorials
- Code documentation
- Deployment guides for other platforms
- Translations

**Bug Fixes:**
- See GitHub issues for reported bugs
- Test edge cases
- Security improvements

## Common Development Tasks

### Adding a New Configuration Field

1. Add to `config/organization.py`
2. Update templates that use it
3. Update documentation
4. Test on test server

### Adding a New Participant Field

1. Add to `config/fields.py`
2. Update registration form (`templates/index.html`)
3. Update models (`models/participant.py`)
4. Update admin interface (`templates/admin/participants.html`)
5. Update CSV export
6. Test thoroughly

### Modifying Email Templates

1. Edit template in `templates/emails/`
2. Use `config/organization.py` variables
3. Test with manual email trigger (test server)
4. Deploy and verify

### Changing Area Configuration

1. Update `config/areas.py`
2. Update `static/data/area_boundaries.json` (if map changes)
3. Test map rendering
4. Verify admin interfaces

### Debugging Deployment Issues

```bash
# Check service status
gcloud run services describe cbc-test --region=us-west1

# View recent logs
gcloud run services logs read cbc-test --region=us-west1 --limit=100

# Tail logs in real-time
gcloud run services logs tail cbc-test --region=us-west1

# Check environment variables
gcloud run services describe cbc-test --region=us-west1 --format="value(spec.template.spec.containers[0].env)"

# Verify secret access
gcloud secrets versions access latest --secret="google-oauth-client-id"
```

### Database Queries and Management

```bash
# Install Firestore dependencies
pip install google-cloud-firestore

# Python console for database queries
python
>>> from google.cloud import firestore
>>> db = firestore.Client(database='cbc-test')
>>> participants = db.collection('participants_2025').stream()
>>> for p in participants:
...     print(p.to_dict())
```

## Getting Help

**Documentation:**
- [SPECIFICATION.md](SPECIFICATION.md) - Technical details
- [DEPLOYMENT.md](DEPLOYMENT.md) - Deployment and configuration
- [CLAUDE.md](../CLAUDE.md) - AI assistant instructions (useful development notes)

**Support:**
- GitHub Issues - Bug reports and feature requests
- Pull Requests - Code review and discussion
- Email - Contact project maintainers

**External Resources:**
- [Flask Documentation](https://flask.palletsprojects.com/)
- [Google Cloud Run Docs](https://cloud.google.com/run/docs)
- [Firestore Documentation](https://cloud.google.com/firestore/docs)
- [Bootstrap 5 Docs](https://getbootstrap.com/docs/5.0/)
- [Leaflet.js Docs](https://leafletjs.com/reference.html)

---

**Happy coding!** Thank you for contributing to the Christmas Bird Count community.

Questions or suggestions? File an issue on the [GitHub repository](https://github.com/naturevancouver/christmas-bird-count-registration/issues).
