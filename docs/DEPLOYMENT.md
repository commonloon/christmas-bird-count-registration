# CBC Registration System - Deployment Guide
<!-- Updated by Claude AI on 2025-10-12 -->

## About This Guide

This guide helps you deploy and maintain the Christmas Bird Count registration system. It's written for volunteers with basic computer skills who may not have cloud engineering experience.

**If you're starting a new registration season**, jump to [Annual Season Start](#annual-season-start) below.

**If this is your first time deploying the system**, start with [Initial Setup](#initial-setup-first-time-only).

**For technical details and troubleshooting**, see [DEPLOYMENT_TECHNICAL_REFERENCE.md](DEPLOYMENT_TECHNICAL_REFERENCE.md).

---

## Annual Season Start

**When to do this**: At the beginning of each registration season (typically October/November)

**What you need**:
- Access to a computer with command line
- Google Cloud login credentials
- 15 minutes

**Steps:**

### 1. Verify Database Indexes

Database indexes ensure the registration system runs quickly. Each year, new collections are created automatically, and indexes must be set up for these collections.

```bash
# Make sure you're logged in to Google Cloud
gcloud auth login

# Run the index verification script for the test environment
python utils/verify_indexes.py cbc-test

# If test looks good, run for production
python utils/verify_indexes.py cbc-register
```

**What you'll see:**
- The script checks if this year's collections exist
- If collections don't exist yet, you'll be prompted to register yourself first
- The script will create any missing indexes automatically
- Index creation takes a few minutes (happens in the background)

**Expected output:**
```
[OK] participants_2025 exists
[OK] removal_log_2025 exists
[OK] Identity-based queries
[NEW] New indexes created: 5
SUCCESS: All indexes are ready!
```

### 2. Test the Registration Form

Visit your test site and register yourself:
- **Test site**: `https://cbc-test.naturevancouver.ca` (or your test domain)
- Fill out the registration form
- Verify you receive a confirmation
- Check that you appear in the admin interface

### 3. Update Admin Accounts (if needed)

If your coordinators have changed, update the admin list:

1. Edit `config/admins.py`
2. Update the `PRODUCTION_ADMIN_EMAILS` list
3. Deploy the updated code (see [Deploying Updates](#deploying-updates))

### 4. Deploy to Production

Once testing is complete:

```bash
# Deploy to production
./deploy.sh production
```

Wait 2-3 minutes for deployment to complete, then test the production registration form.

### 5. Share Registration URL

Send participants to:
- **Production**: `https://cbc-registration.naturevancouver.ca` (or your production domain)

---

## Deploying Updates

**When to do this**: When you need to deploy code changes or configuration updates

```bash
# Deploy to test environment (always test first!)
./deploy.sh test

# After testing, deploy to production
./deploy.sh production

# Or deploy to both at once
./deploy.sh both
```

**Deployment takes 2-3 minutes**. You'll see build progress and a success message with the service URL.

---

## Common Tasks

### Viewing Application Logs

If you need to troubleshoot issues:

```bash
# View recent logs (test)
gcloud run services logs read cbc-test --region=us-west1 --limit=50

# View recent logs (production)
gcloud run services logs read cbc-registration --region=us-west1 --limit=50

# Watch logs in real-time
gcloud run services logs tail cbc-test --region=us-west1
```

### Checking Service Status

```bash
# Check test service
gcloud run services describe cbc-test --region=us-west1

# Check production service
gcloud run services describe cbc-registration --region=us-west1
```

### Exporting Participant Data

Use the admin interface at `/admin` to export CSV files of:
- All participants
- Area leaders
- Participants by area

---

## Initial Setup (First Time Only)

**When to do this**: Only when deploying the system for the first time

**What you need**:
- Google Cloud account with billing enabled
- Domain name for your organization
- 2-3 hours for complete setup

> [!CAUTION]
> The macOS and Linux instructions were generated by Claude.ai and are completely untested. 
> Development and testing were done on Windows.
> 
### 1. Install Google Cloud CLI

#### Windows
1. Download from https://cloud.google.com/sdk/docs/install
2. Run the installer
3. Restart PowerShell

#### macOS
```bash
brew install google-cloud-sdk
```

#### Linux (Ubuntu/Debian)
```bash
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
sudo apt-get update && sudo apt-get install google-cloud-cli
```

### 2. Authenticate and Configure

```bash
# Log in to Google Cloud
gcloud auth login

# Set your project ID
gcloud config set project YOUR-PROJECT-ID

# Verify
gcloud config list
```

### 3. Enable Required Services

```bash
gcloud services enable run.googleapis.com
gcloud services enable firestore.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable cloudscheduler.googleapis.com
```

### 4. Configure Your Organization

Edit `config/organization.py` with your club's details:
- Organization name
- Contact emails
- Domain names
- Timezone

See [DEPLOYMENT_TECHNICAL_REFERENCE.md](DEPLOYMENT_TECHNICAL_REFERENCE.md) for detailed configuration instructions.

### 5. Create Firestore Databases

```bash
# Install Python dependencies
pip install -r utils/requirements.txt

# Create databases
python utils/setup_databases.py
```

This creates two databases:
- `cbc-test`: For testing
- `cbc-register`: For production

### 6. Set Up OAuth Authentication

OAuth allows admins and area leaders to log in with Google accounts.

**Detailed instructions**: See [OAUTH-SETUP.md](OAUTH-SETUP.md)

**Quick steps:**
1. Create OAuth client in Google Cloud Console
2. Download `client_secret.json`
3. Run `./utils/setup_oauth_secrets.sh`
4. Delete `client_secret.json`
5. Publish OAuth consent screen

### 7. Configure Admin Accounts

Edit `config/admins.py` and add admin email addresses:

```python
PRODUCTION_ADMIN_EMAILS = [
    'your-admin@yourclub.org',
    'another-admin@yourclub.org'
]
```

### 8. Initial Deployment

```bash
# Deploy to test first
./deploy.sh test

# Test thoroughly, then deploy to production
./deploy.sh production
```

### 9. Configure Custom Domains

```bash
# Map test domain
gcloud run domain-mappings create \
    --service cbc-test \
    --domain cbc-test.yourclub.org \
    --region us-west1

# Map production domain
gcloud run domain-mappings create \
    --service cbc-registration \
    --domain cbc-registration.yourclub.org \
    --region us-west1
```

Add CNAME records in your DNS provider:
```
Name: cbc-test
Type: CNAME
Value: ghs.googlehosted.com

Name: cbc-registration
Type: CNAME
Value: ghs.googlehosted.com
```

SSL certificates are automatically provisioned (takes up to 24 hours).

### 10. Configure Email Scheduler (Optional)

For automated email notifications to area leaders:

```bash
# Create service account (one time)
gcloud iam service-accounts create cloud-scheduler-invoker \
    --display-name="Cloud Scheduler Email Invoker"

# Grant permissions to test service
gcloud run services add-iam-policy-binding cbc-test \
    --region=us-west1 \
    --member="serviceAccount:cloud-scheduler-invoker@YOUR-PROJECT-ID.iam.gserviceaccount.com" \
    --role="roles/run.invoker"

# Grant permissions to production service
gcloud run services add-iam-policy-binding cbc-registration \
    --region=us-west1 \
    --member="serviceAccount:cloud-scheduler-invoker@YOUR-PROJECT-ID.iam.gserviceaccount.com" \
    --role="roles/run.invoker"

# Create scheduler jobs
./utils/setup_email_scheduler.sh test
./utils/setup_email_scheduler.sh production
```

---

## Getting Help

### Error Messages

**"Database does not exist"**
- Run `python utils/setup_databases.py` to create databases

**"OAuth client not found"**
- Follow steps in [OAUTH-SETUP.md](OAUTH-SETUP.md)
- Verify OAuth consent screen is published

**"Permission denied"**
- Run `gcloud auth login`
- Verify you have correct project permissions

**"Index creation required" in logs**
- Run `python utils/verify_indexes.py cbc-test` (or `cbc-register`)

### Where to Find More Information

- **Technical details**: [DEPLOYMENT_TECHNICAL_REFERENCE.md](DEPLOYMENT_TECHNICAL_REFERENCE.md)
- **OAuth setup**: [OAUTH-SETUP.md](OAUTH-SETUP.md)
- **Email system**: [EMAIL_SCHEDULER_TESTING.md](EMAIL_SCHEDULER_TESTING.md)
- **Application features**: [SPECIFICATION.md](SPECIFICATION.md)
- **Development guide**: [CLAUDE.md](CLAUDE.md)

### Support Resources

- **Cloud Run Documentation**: https://cloud.google.com/run/docs
- **Firestore Documentation**: https://cloud.google.com/firestore/docs
- **Google Cloud Console**: https://console.cloud.google.com

---

## Adapting for Another Bird Count Club

This system is designed to be portable. To use it for your club:

### Configuration Files to Update

1. **`config/organization.py`** - All organization-specific settings
2. **`config/admins.py`** - Admin email addresses
3. **`config/areas.py`** - Count area definitions
4. **`static/data/area_boundaries.json`** - Geographic boundaries

### Domain and Email Setup

1. Update domain references in `config/organization.py`
2. Configure OAuth consent screen with your domain
3. Update DNS records for your domain
4. Configure SMTP settings in `config/email_settings.py`

### Deployment

Follow the [Initial Setup](#initial-setup-first-time-only) steps using your:
- Google Cloud project ID
- Custom domain names
- Organization email addresses

**No code changes should be required** - everything is configuration-based.

---

## Maintenance Tips

### During Registration Season

1. **Monitor daily**: Check logs for errors
2. **Export regularly**: Download participant lists weekly
3. **Test changes**: Always deploy to `cbc-test` first
4. **Back up data**: Firestore backs up automatically (see [BACKUPS.md](BACKUPS.md))

### Off-Season

1. **Keep services running**: Data persists year-to-year
2. **Cloud Run scales to zero**: Minimal costs during low-traffic periods
3. **Review billing**: Monitor at https://console.cloud.google.com/billing

### Before Next Season

1. **Run annual season start procedure** (see top of this document)
2. **Update admin accounts** if coordinators changed
3. **Test thoroughly** before opening registration
4. **Review and update count areas** if boundaries changed
